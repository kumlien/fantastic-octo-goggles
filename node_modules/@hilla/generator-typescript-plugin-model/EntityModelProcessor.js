import{dirname as b}from"path/posix";import{convertReferenceSchemaToPath as P,convertReferenceSchemaToSpecifier as M,decomposeSchema as y,isComposedSchema as f,isEmptyObject as D,isEnumSchema as T,isObjectSchema as w,isReferenceSchema as R}from"@hilla/generator-typescript-core/Schema.js";import{convertFullyQualifiedNameToRelativePath as $,simplifyFullyQualifiedName as N}from"@hilla/generator-typescript-core/utils.js";import I from"@hilla/generator-typescript-utils/createSourceFile.js";import j from"@hilla/generator-typescript-utils/dependencies/DependencyManager.js";import h from"@hilla/generator-typescript-utils/dependencies/PathManager.js";import t from"typescript";import{ModelSchemaExpressionProcessor as O,ModelSchemaTypeProcessor as v}from"./ModelSchemaProcessor.js";import{importBuiltInFormModel as u,createModelBuildingCallback as k,createEmptyValueMaker as S}from"./utils.js";const s=Symbol(),d=Symbol(),g=Symbol(),c=Symbol(),p=Symbol();class C{static process(e,r,o){o.owner.logger.debug(`Processing model for entity: ${e}`);const a=f(r)?y(r)[0]:r;return T(a)?new K(e).process():new F(e,r,o).process()}[s];[d];[g];[c];#e=new h({extension:"ts"});constructor(e,r){this[g]=e;const o=N(e),a=$(e),n=`${o}Model`,i=`${a}Model`;this[s]=new j(new h({extension:".js",relativeTo:b(i)}));const{exports:l,imports:x,paths:E}=this[s];this[c]={id:l.default.set(n),path:i},this[d]={id:x.default.add(E.createRelativePath(a),o,r),path:a}}process(){const e=this[p](),{exports:r,imports:o}=this[s],a=o.toCode(),n=r.toCode();return I([...a,e,...n].filter(Boolean),this.#e.createRelativePath(this[c].path))}}class F extends C{#e;#r;#t;#o;#a;constructor(e,r,o){super(e,!0),this.#e=r,this.#r=o,this.#t=e,this.#o=this[s].imports.named.add("@hilla/form","_getPropertyModel"),this.#a=this[s].imports.named.add("@hilla/form","makeObjectEmptyValueCreator")}[p](){const{logger:e}=this.#r.owner;let r=this.#e,o;if(f(this.#e)){const a=y(this.#e);if(a.length>2){e.debug(this.#e,`The schema for a class component ${this.#t} has more than two components. This plugin will ignore it.`);return}const[n,i]=a;if(!R(n)){e.debug(n,"Only reference schema allowed for parent class");return}r=i,o=this.#i(n)}else o=u("ObjectModel",this[s]);return this.#s(r,this[d].id,o)}#n({properties:e}){return e?Object.entries(e).map(([r,o])=>{const a=new v(o,this[s]).process(),n=new O(o,this[s]).process();return t.factory.createGetAccessorDeclaration(void 0,t.factory.createIdentifier(r),[],a,t.factory.createBlock([t.factory.createReturnStatement(t.factory.createCallExpression(t.factory.createElementAccessExpression(t.factory.createThis(),this.#o),void 0,[t.factory.createStringLiteral(r),k(a.typeName,n)]))],!0))}):[]}#s(e,r,o){const{logger:a}=this.#r.owner;if(!w(e)){a.debug(e,`Component is not an object: ${this.#t}`);return}D(e)&&a.warn(`Component has no properties: ${this.#t}`);const n=t.factory.createIdentifier("T"),i=t.factory.createTypeParameterDeclaration(void 0,n,t.factory.createTypeReferenceNode(r),t.factory.createTypeReferenceNode(r));return t.factory.createClassDeclaration(void 0,this[c].id,[i],[t.factory.createHeritageClause(t.SyntaxKind.ExtendsKeyword,[t.factory.createExpressionWithTypeArguments(o,[t.factory.createTypeReferenceNode(n)])])],[S(this.#a,this[c].id),...this.#n(e)])}#i(e){const{imports:r,paths:o}=this[s],a=M(e),n=P(e),i=o.createRelativePath(`${n}Model`),l=`${a}Model`;return r.default.add(i,l,!1)}}class K extends C{constructor(e){super(e,!1)}[p](){const e=u("EnumModel",this[s]),r=this[s].imports.named.add("@hilla/form","_enum"),o=this[s].imports.named.add("@hilla/form","makeEnumEmptyValueCreator");return t.factory.createClassDeclaration(void 0,this[c].id,void 0,[t.factory.createHeritageClause(t.SyntaxKind.ExtendsKeyword,[t.factory.createExpressionWithTypeArguments(e,[t.factory.createTypeQueryNode(this[d].id,void 0)])])],[S(o,this[c].id),t.factory.createPropertyDeclaration([t.factory.createModifier(t.SyntaxKind.ReadonlyKeyword)],t.factory.createComputedPropertyName(r),void 0,void 0,this[d].id)])}}export{F as EntityClassModelProcessor,K as EntityEnumModelProcessor,C as EntityModelProcessor};
//# sourceMappingURL=EntityModelProcessor.js.map
